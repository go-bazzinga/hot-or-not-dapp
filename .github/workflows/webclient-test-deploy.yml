name: Web-client tests
on:
  pull_request:
    branches:
      - main
    paths:
      - "packages/web-client/**"
      - ".github/workflows/webclient-deploy.yml"
      - ".github/workflows/webclient-setup/action.yml"
      - ".github/workflows/webclient-test.yml"
      - ".github/workflows/webclient-test-deploy.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    outputs:
      previewUrl: ${{ steps.preview-url.outputs.url }}
    steps:
      - uses: actions/checkout@v2
      - name: Set-up env
        uses: ./.github/workflows/webclient-setup
      - run: npm run wc:build

      - name: Deploy preview build
        uses: cloudflare/wrangler-action@2.0.0
        with:
          apiToken: ${{ secrets.CLOUDFLARE_WORKERS_DEPLOY_API_TOKEN }}
          workingDirectory: "packages/web-client/"
          command: pages publish ".svelte-kit/cloudflare" --branch=${{ github.head_ref }} --project-name=hot-or-not-web-client --commit-dirty=true | tee url.txt
        env:
          CLOUDFLARE_ACCOUNT_ID: "a209c523d2d9646cc56227dbe6ce3ede"
      - name: Get preview deployment URL
        id: preview-url
        working-directory: "packages/web-client/"
        run: |
          echo "url=$(grep -o 'http[s]*://[^\\]*' url.txt)" >> $GITHUB_OUTPUT

  google-chat-webhook:
    name: Google chat bot
    if: github.actor != 'dependabot[bot]'
    needs: ["deploy-preview"]
    runs-on: ubuntu-latest
    steps:
      - name: Send deployment URL to Google Chat
        uses: fjogeleit/http-request-action@v1.12.0
        with:
          url: "https://chat.googleapis.com/v1/spaces/AAAAAfsrp8U/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=_QvV-c8ZdTVTzGZxXW_PdR_o-0HI8VhO3I9dMAp6zls%3D"
          method: "POST"
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"text": "PR: \"${{ github.event.pull_request.title  }}\" deployed at: \n ${{ needs.deploy-preview.outputs.previewUrl }}"}'
